<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Transactions - Tailor Shop</title>
  <link rel="stylesheet" href="/static/css/style.css">
  <link rel="icon" href="/static/img/abjad-logo.png" type="image/png">
</head>
<body>
  <div class="dashboard-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="/static/img/abjad-logo.png" alt="Abjad" class="sidebar-logo-img">
          <div class="sidebar-logo-wrap">
            <span class="sidebar-logo-text">Abjad</span>
            <span class="sidebar-logo-tagline">tailor management system</span>
          </div>
        </div>
      </div>
      <nav class="sidebar-nav">
        <span class="sidebar-nav-label">Main</span>
        <a href="/dashboard" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="3" width="7" height="7"/><rect x="14" y="3" width="7" height="7"/><rect x="14" y="14" width="7" height="7"/><rect x="3" y="14" width="7" height="7"/></svg></span>
          <span class="sidebar-nav-text">Dashboard</span>
        </a>
        <span class="sidebar-nav-label">Operations</span>
        <a href="/customers" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><path d="M23 21v-2a4 4 0 0 0-3-3.87"/><path d="M16 3.13a4 4 0 0 1 0 7.75"/></svg></span>
          <span class="sidebar-nav-text">Customers</span>
        </a>
        <a href="/orders" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/></svg></span>
          <span class="sidebar-nav-text">Orders</span>
        </a>
        <a href="/measurements" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 21H4V3"/><path d="M14 3v18"/><path d="M8 3v18"/></svg></span>
          <span class="sidebar-nav-text">Measurements</span>
        </a>
        <a href="/payments" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="1" y="4" width="22" height="16" rx="2" ry="2"/><line x1="1" y1="10" x2="23" y2="10"/></svg></span>
          <span class="sidebar-nav-text">Payments</span>
        </a>
        <a href="/transactions" class="sidebar-nav-link active">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M12 2v20M17 5H9.5a3.5 3.5 0 0 0 0 7h5a3.5 3.5 0 0 1 0 7H6"/></svg></span>
          <span class="sidebar-nav-text">Transactions</span>
        </a>
        <a href="/swap" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M7 16V4M7 4L3 8M7 4l4 4"/><path d="M17 8v12M17 20l4-4M17 20l-4-4"/></svg></span>
          <span class="sidebar-nav-text">Swap</span>
        </a>
        <a href="/banks" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><rect x="2" y="4" width="20" height="16" rx="2"/><path d="M2 10h20"/><path d="M6 14h2"/><path d="M10 14h2"/></svg></span>
          <span class="sidebar-nav-text">Banks</span>
        </a>
        <a href="/stock" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z"/><polyline points="3.27 6.96 12 12.01 20.73 6.96"/><line x1="12" y1="22.08" x2="12" y2="12"/></svg></span>
          <span class="sidebar-nav-text">Stock</span>
        </a>
        <a href="/store" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M6 2L3 6v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2V6l-3-4z"/><line x1="3" y1="6" x2="21" y2="6"/><path d="M16 10a4 4 0 0 1-8 0"/><path d="M12 14v4"/></svg></span>
          <span class="sidebar-nav-text">Store</span>
        </a>
        <a href="/tasks" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M9 11l3 3L22 4"/><path d="M21 12v7a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h11"/></svg></span>
          <span class="sidebar-nav-text">Tasks</span>
        </a>
        <span class="sidebar-nav-label">Reports</span>
        <a href="/reports" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><line x1="18" y1="20" x2="18" y2="10"/><line x1="12" y1="20" x2="12" y2="4"/><line x1="6" y1="20" x2="6" y2="14"/></svg></span>
          <span class="sidebar-nav-text">Reports</span>
        </a>
        <a href="/staff" class="sidebar-nav-link nav-admin-only">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M16 21v-2a4 4 0 0 0-4-4H6a4 4 0 0 0-4 4v2"/><circle cx="9" cy="7" r="4"/><line x1="19" y1="8" x2="19" y2="14"/><line x1="22" y1="11" x2="16" y2="11"/></svg></span>
          <span class="sidebar-nav-text">Staff</span>
        </a>
        <span class="sidebar-nav-label">Account</span>
        <a href="/settings" class="sidebar-nav-link">
          <span class="sidebar-nav-icon"><svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><circle cx="12" cy="12" r="3"/><path d="M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-1.08A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h1.08A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v1.08a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-1.08a1.65 1.65 0 0 0-1.51 1z"/></svg></span>
          <span class="sidebar-nav-text">Settings</span>
        </a>
      </nav>
      <div class="sidebar-footer">
        <button type="button" class="sidebar-theme-btn" id="sidebarThemeBtn" title="Toggle theme" aria-label="Toggle theme"></button>
        <div class="sidebar-user">
          <div class="sidebar-user-avatar" id="sidebarUserAvatar">JD</div>
          <div class="sidebar-user-info">
            <span class="sidebar-user-name" id="sidebarUserName">User</span>
            <span class="sidebar-user-role" id="sidebarUserRole">Admin</span>
          </div>
        </div>
        <a href="#" class="sidebar-logout" id="sidebarLogout" title="Sign out">Sign out</a>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="main-content">
      <div class="main-header">
        <div class="welcome-text">Transactions</div>
        <div class="header-right">
          <div class="search-wrap">
            <span class="search-icon" aria-hidden="true">üîç</span>
            <input type="text" class="search-input" id="headerSearch" placeholder="Search transactions...">
          </div>
          <div class="header-user-wrap">
            <div class="user-dropdown" id="userProfile" tabindex="0" role="button" aria-haspopup="true" aria-expanded="false">
              <div class="user-avatar-small" id="userAvatar">JD</div>
              <span class="header-user-name" id="headerUserName">User</span>
              <span style="font-size: 11px; color: var(--text-muted);">‚ñº</span>
            </div>
            <div id="userDropdownMenu" class="user-dropdown-menu" role="menu" aria-hidden="true">
              <a href="/dashboard" role="menuitem">Dashboard</a>
              <a href="/customers" role="menuitem">Customers</a>
              <a href="/orders" role="menuitem">Orders</a>
              <div class="dropdown-divider"></div>
              <button type="button" id="headerLogoutBtn" role="menuitem">Sign out</button>
            </div>
          </div>
        </div>
      </div>

      <div class="page-content">
        <!-- Add Transaction form -->
        <div class="add-transaction-card">
          <h2 class="add-transaction-title">Add Transaction</h2>
          <form id="transactionForm">
            <div class="add-transaction-grid">
              <div class="form-group">
                <label for="currency">Choose Account</label>
                <select id="currency" required>
                  <option value="KES" selected>KES (Default)</option>
                  <option value="USD">USD</option>
                </select>
              </div>
              <div class="form-group">
                <label for="category">Choose Transaction Category</label>
                <select id="category">
                  <option value="">Choose Transaction Category</option>
                  <option value="sales">Sales</option>
                  <option value="expense">Expense</option>
                  <option value="salary">Salary</option>
                  <option value="supplies">Supplies</option>
                  <option value="other">Other</option>
                </select>
              </div>
              <div class="form-group">
                <label for="amount">Transaction Amount</label>
                <input type="number" id="amount" step="0.01" min="0" placeholder="Enter transaction amount" required>
              </div>
              <div class="form-group">
                <label>Transaction Type</label>
                <div class="transaction-type-radio">
                  <label><input type="radio" name="transaction_type" value="in" checked> IN</label>
                  <label><input type="radio" name="transaction_type" value="out"> OUT</label>
                </div>
              </div>
              <div class="form-group">
                <label for="method">Transaction Method</label>
                <select id="method" required>
                  <option value="">Select transaction type</option>
                  <option value="cash" selected>Cash</option>
                  <option value="digital">Digital</option>
                </select>
              </div>
              <div class="form-group">
                <label for="transaction_date">Transaction Date</label>
                <input type="datetime-local" id="transaction_date">
              </div>
              <div class="form-group full-width">
                <label for="details">Transaction Details</label>
                <textarea id="details" placeholder="Enter transaction details" rows="3"></textarea>
              </div>
            </div>
            <div class="add-transaction-actions">
              <button type="submit" class="btn btn-primary">Save Transaction</button>
            </div>
          </form>
        </div>

        <!-- Transactions list -->
        <div class="dashboard-card">
          <h4 style="margin-bottom: 12px;">Transactions</h4>
          <div class="table-responsive">
            <table class="customers-table">
              <thead>
                <tr>
                  <th>Date</th>
                  <th>Account</th>
                  <th>Category</th>
                  <th>Amount</th>
                  <th>Type</th>
                  <th>Method</th>
                  <th>Details</th>
                </tr>
              </thead>
              <tbody id="list"></tbody>
            </table>
          </div>
          <div class="table-pagination" id="pagination"></div>
        </div>
      </div>
    </main>
  </div>

  <script src="/static/js/api.js"></script>
  <script src="/static/js/theme.js"></script>
  <script src="/static/js/notifications.js"></script>
  <script>
    const user = requireAuth();
    if (!user) { throw new Error('Auth required'); }

    const userName = user.full_name || user.username || 'User';
    const initials = userName.split(' ').map(n => n[0]).join('').toUpperCase().slice(0, 2);
    const roleLabel = (user.role || 'user').charAt(0).toUpperCase() + (user.role || 'user').slice(1);

    document.getElementById('userAvatar').textContent = initials;
    document.getElementById('headerUserName').textContent = userName;
    document.getElementById('sidebarUserAvatar').textContent = initials;
    document.getElementById('sidebarUserName').textContent = userName;
    document.getElementById('sidebarUserRole').textContent = roleLabel;

    (function() {
      initTheme();
      var btn = document.getElementById('sidebarThemeBtn');
      if (btn) {
        btn.textContent = getTheme() === 'light' ? '\u{1F319}' : '\u{1F506}';
        btn.onclick = function() { toggleTheme(); btn.textContent = getTheme() === 'light' ? '\u{1F319}' : '\u{1F506}'; };
      }
    })();

    document.getElementById('sidebarLogout').addEventListener('click', function(e) {
      e.preventDefault();
      logout();
    });
    document.getElementById('headerLogoutBtn').addEventListener('click', function() {
      logout();
    });

    (function() {
      var profile = document.getElementById('userProfile');
      var menu = document.getElementById('userDropdownMenu');
      function open() { menu.classList.add('show'); menu.setAttribute('aria-hidden', 'false'); profile.setAttribute('aria-expanded', 'true'); }
      function close() { menu.classList.remove('show'); menu.setAttribute('aria-hidden', 'true'); profile.setAttribute('aria-expanded', 'false'); }
      profile.addEventListener('click', function(e) { e.stopPropagation(); open(); });
      document.addEventListener('click', function(e) {
        if (!profile.contains(e.target) && !menu.contains(e.target)) close();
      });
    })();

    if (user.role !== 'admin') document.querySelectorAll('.nav-admin-only').forEach(el => el.classList.add('hidden'));

    function escapeHtml(s) {
      if (s == null || s === '') return '-';
      var d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    // Default transaction date to now (local)
    function setDefaultTransactionDate() {
      var el = document.getElementById('transaction_date');
      if (el && !el.value) {
        var d = new Date();
        var y = d.getFullYear(), m = String(d.getMonth() + 1).padStart(2, '0'), day = String(d.getDate()).padStart(2, '0');
        var h = String(d.getHours()).padStart(2, '0'), min = String(d.getMinutes()).padStart(2, '0');
        el.value = y + '-' + m + '-' + day + 'T' + h + ':' + min;
      }
    }
    setDefaultTransactionDate();

    document.getElementById('transactionForm').onsubmit = async function(e) {
      e.preventDefault();
      var currency = document.getElementById('currency').value;
      var category = document.getElementById('category').value;
      var amount = document.getElementById('amount').value;
      var method = document.getElementById('method').value;
      var typeRadio = document.querySelector('input[name="transaction_type"]:checked');
      var transaction_type = typeRadio ? typeRadio.value : 'in';
      var transaction_date = document.getElementById('transaction_date').value;
      var details = document.getElementById('details').value;
      if (!amount || !method) { showToast('Amount and transaction method are required', 'error'); return; }
      var payload = {
        currency: currency,
        category: category || null,
        amount: parseFloat(amount),
        transaction_type: transaction_type,
        method: method,
        details: details || null
      };
      if (transaction_date) {
        var d = new Date(transaction_date);
        payload.transaction_date = d.getFullYear() + '-' + String(d.getMonth() + 1).padStart(2, '0') + '-' + String(d.getDate()).padStart(2, '0') + ' ' + String(d.getHours()).padStart(2, '0') + ':' + String(d.getMinutes()).padStart(2, '0') + ':00';
      }
      try {
        await api('/transactions', { method: 'POST', body: JSON.stringify(payload) });
        showToast('Transaction saved', 'success');
        document.getElementById('amount').value = '';
        document.getElementById('details').value = '';
        setDefaultTransactionDate();
        load(1);
      } catch (err) {
        showToast(err.message || 'Failed to save transaction', 'error');
      }
    };

    let currentPage = 1;

    async function load(page) {
      page = page || 1;
      currentPage = page;
      try {
        const res = await api('/transactions?page=' + page + '&per_page=25');
        const items = res.items || [];
        const total = res.total || 0;
        const pages = res.pages || 1;
        const searchTerm = (document.getElementById('headerSearch').value || '').toLowerCase();
        const filtered = searchTerm
          ? items.filter(t => {
              const cat = (t.category || '').toLowerCase();
              const det = (t.details || '').toLowerCase();
              const cur = (t.currency || '').toLowerCase();
              const meth = (t.method || '').toLowerCase();
              const typ = (t.transaction_type || '').toLowerCase();
              const amt = String(t.amount || '');
              return cat.includes(searchTerm) || det.includes(searchTerm) || cur.includes(searchTerm) || meth.includes(searchTerm) || typ.includes(searchTerm) || amt.includes(searchTerm);
            })
          : items;

        const tbody = document.getElementById('list');
        const sym = function(c) { return c === 'USD' ? '$' : 'KSh '; };
        if (filtered.length === 0) {
          tbody.innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 24px; color: var(--text-muted);">No transactions found</td></tr>';
        } else {
          tbody.innerHTML = filtered.map(t => {
            var date = (t.transaction_date || t.created_at || '').slice(0, 19).replace('T', ' ');
            if (!date) date = '-';
            var typeLabel = (t.transaction_type || 'in') === 'in' ? 'IN' : 'OUT';
            var typeClass = typeLabel === 'IN' ? 'badge-completed' : 'badge-pending';
            return '<tr>' +
              '<td>' + escapeHtml(date) + '</td>' +
              '<td>' + escapeHtml(t.currency || 'KES') + '</td>' +
              '<td>' + escapeHtml(t.category) + '</td>' +
              '<td><strong>' + sym(t.currency) + Number(t.amount).toFixed(2) + '</strong></td>' +
              '<td><span class="badge ' + typeClass + '">' + typeLabel + '</span></td>' +
              '<td>' + escapeHtml(t.method) + '</td>' +
              '<td>' + escapeHtml(t.details) + '</td>' +
              '</tr>';
          }).join('');
        }

        const pagEl = document.getElementById('pagination');
        if (pages <= 1) {
          pagEl.innerHTML = '<span class="text-muted">Total: ' + total + ' transaction(s)</span>';
        } else {
          var links = '';
          if (page > 1) links += '<a href="#" class="btn btn-secondary btn-sm" data-page="' + (page - 1) + '">Previous</a> ';
          links += '<span class="text-muted">Page ' + page + ' of ' + pages + ' (' + total + ' total)</span>';
          if (page < pages) links += ' <a href="#" class="btn btn-secondary btn-sm" data-page="' + (page + 1) + '">Next</a>';
          pagEl.innerHTML = links;
          pagEl.querySelectorAll('[data-page]').forEach(a => {
            a.addEventListener('click', function(ev) { ev.preventDefault(); load(parseInt(this.getAttribute('data-page'), 10)); });
          });
        }
      } catch (err) {
        showToast(err.message || 'Failed to load transactions', 'error');
        document.getElementById('list').innerHTML = '<tr><td colspan="7" style="text-align:center; padding: 24px; color: var(--text-danger);">Failed to load transactions</td></tr>';
      }
    }

    document.getElementById('headerSearch').addEventListener('input', function() {
      load(currentPage);
    });

    load(1);
  </script>
</body>
</html>
